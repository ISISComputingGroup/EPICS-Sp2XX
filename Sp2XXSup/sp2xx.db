record(bo, "$(P)SIM")
{
    field(SCAN, "Passive")
    field(DTYP, "Soft Channel")
    field(ZNAM, "NO")
    field(ONAM, "YES")
    field(VAL, "$(RECSIM=0)")
}

record(bo, "$(P)DISABLE") 
{
    field(DESC, "Disable comms")
    field(PINI, "YES")
    field(VAL, "$(DISABLE=0)")
    field(OMSL, "supervisory")
    field(ZNAM, "COMMS ENABLED")
    field(ONAM, "COMMS DISABLED")
}

record(bo, "$(P)RUN:SP"){    
    field(DESC, "Starts the pump.")
    field(SCAN, "Passive")
    field(DTYP, "stream")

    field(OUT,  "@sp2xx.proto run($(P),ERROR,NA) $(PORT)")
    
    field(ZNAM, "")
    field(ONAM, "Run")
    
    info(INTEREST, "HIGH")
    field(SIML, "$(P)SIM")
    field(SIOL, "$(P)SIM:RUN:SP.PROC")
    field(SDIS, "$(P)DISABLE")
}

record(bo, "$(P)STOP:SP"){    
    field(DESC, "Stops the pump.")
    field(SCAN, "Passive")
    field(DTYP, "stream")
    
    field(OUT,  "@sp2xx.proto stop($(P),ERROR,NA) $(PORT)")
    
    field(ZNAM, "")
    field(ONAM, "STOP")
       
    info(INTEREST, "HIGH")
    field(SIML, "$(P)SIM")
    field(SIOL, "$(P)SIM:STOP:SP.PROC")
    field(SDIS, "$(P)DISABLE")
}

record(mbbi, "$(P)STATUS"){    
    field(DESC, "Gets the pump status.")
    field(SCAN, "1 second")
    field(DTYP, "stream")

    
    field(INP,  "@sp2xx.proto run_status($(P),ERROR) $(PORT)")
    
    field(ZRVL, "0")
    field(ONVL, "1")
    field(TWVL, "2")
    
    field(ZRST, "Stopped")
    field(ONST, "Infusion")
    field(TWST, "Withdrawal")
    
    info(alarm, "Sp2XX")
    info(INTEREST, "HIGH")
    info(archive, "VAL")
    field(SIML, "$(P)SIM")
    field(SIOL, "$(P)SIM:STATUS")
    field(SDIS, "$(P)DISABLE")
}

record (mbbi, "$(P)ERROR"){
    field(SCAN, "Passive")  # This is triggered on a mismatch hangler in the protocol
    field(DESC, "Error type recorded after E prompt.")
    field(DTYP, "stream")
    field(PINI, "YES")
    
    field(INP,  "@sp2xx.proto error_status($(P),ERROR) $(PORT)")
    field(VAL, "0")
    
    field(ZRVL, "0")
    field(ONVL, "1")
    field(TWVL, "2")
    field(THVL, "3")
    field(FRVL, "4")
    field(FVVL, "5")
    field(SXVL, "6")
    field(SVVL, "7")
    
    
    field(ZRST, "No error")
    field(ZRSV, "NO_ALARM")
    field(ONST, "Comms error")
    field(ONSV, "MAJOR")
    field(TWST, "Stall")
    field(TWSV, "MAJOR")
    field(THST, "Comms error and stall")
    field(THSV, "MAJOR")
    
    field(FRST, "Serial overrun")
    field(FRSV, "MAJOR")
    field(FVST, "Serial error and overrun")
    field(FVSV, "MAJOR")
    field(SXST, "Stall and serial overrun")
    field(SXSV, "MAJOR")
    field(SVST, "Stall ser err and overun")
    field(SVSV, "MAJOR")
    
    info(archive, "VAL")
    field(SIML, "$(P)SIM")
    field(SIOL, "$(P)SIM:ERROR")
    field(SDIS, "$(P)DISABLE")
}

record(bi, "$(P)NA") {
    field(DESC, "Record keeps track if NA is triggered.")
    field(DTYP, "Soft Channel")
    field(PINI, "YES")
    field(VAL, "1")
    
    field(ZNAM, "Can't run command")
    field(ONAM, "No error")
    
    info(archive, "VAL")
}

record(mbbo, "$(P)MODE:SP"){
    field(DESC, "Sets the mode of the device.")
    field(DTYP, "stream")
    
    field(OUT,  "@sp2xx.proto set_mode($(P),ERROR,NA) $(PORT)")
    
    field(ZRVL, "0")
    field(ONVL, "1")
    field(TWVL, "2")
    field(THVL, "3")
    field(FRVL, "4")
    
    field(ZRST, "Infusion/Withdrawal")
    field(ONST, "Withdrawal/Infusion")
    field(TWST, "Infusion")
    field(THST, "Withdrawal")
    field(FRST, "Continuous")
    
    info(archive, "VAL")
    field(SIML, "$(P)SIM")
    field(SIOL, "$(P)SIM:MODE:SP")
    field(SDIS, "$(P)DISABLE")
}


record(mbbi, "$(P)MODE"){
    field(DESC, "Gets the mode of the device.")
    field(SCAN, "1 second")
    field(DTYP, "stream")
    
    field(INP,  "@sp2xx.proto get_mode($(P),ERROR) $(PORT)")
    
    field(ZRVL, "0")
    field(ONVL, "1")
    field(TWVL, "2")
    field(THVL, "3")
    field(FRVL, "4")
    
    field(ZRST, "Infusion/Withdrawal")
    field(ONST, "Withdrawal/Infusion")
    field(TWST, "Infusion")
    field(THST, "Withdrawal")
    field(FRST, "Continuous")
    
    info(archive, "VAL")
    info(INTEREST, "HIGH")
    field(SIML, "$(P)SIM")
    field(SIOL, "$(P)SIM:MODE")
    field(SDIS, "$(P)DISABLE")
}

record(bi, "$(P)DIRECTION") {
    field(DESC, "Gets the direction of the device.")
    field(SCAN, "1 second")
    field(DTYP, "stream")
    
    field(INP, "@sp2xx.proto get_direction($(P),ERROR) $(PORT)")
    
    field(ZNAM, "Infusion")
    field(ONAM, "Withdrawal")
    
    info(archive, "VAL")
    info(INTEREST, "HIGH")
    field(SIML, "$(P)SIM")
    field(SIOL, "$(P)SIM:DIRECTION")
    field(SDIS, "$(P)DISABLE")
}

record(bo, "$(P)DIRECTION:REV") {
    field(DESC, "Reverse the direction of the device.")
    field(SCAN, "Passive")
    field(DTYP, "stream")
    
    field(OUT, "@sp2xx.proto reverse_direction($(P),ERROR,NA) $(PORT)")
    
    field(ZNAM, "")
    field(ONAM, "Reverse")
    
    info(INTEREST, "MEDIUM")
    field(SIML, "$(P)SIM")
    field(SIOL, "$(P)SIM:DIRECTION:REV.PROC")
    field(SDIS, "$(P)DISABLE")
}

record(ai, "$(P)DIAMETER") {
    field(DESC, "Requests the current diameter settings.")
    field(SCAN, "1 second")
    field(DTYP, "stream")
    
    field(INP, "@sp2xx.proto get_diam($(P),ERROR) $(PORT)")
    field(EGU, "mm")
    
    info(archive, "VAL")
    info(INTEREST, "MEDIUM")
    field(SIML, "$(P)SIM")
    field(SIOL, "$(P)SIM:DIAMETER")
    field(SDIS, "$(P)DISABLE")
}

record(ao, "$(P)DIAMETER:SP") {
    field(DESC, "Sets the syringe diameter settings.")
    field(DTYP, "stream")
    
    field(OUT, "@sp2xx.proto set_diam($(P),ERROR,NA) $(PORT)")
    field(PREC, "2") 
    field(EGU, "mm")
    
    info(archive, "VAL")
    field(SIML, "$(P)SIM")
    field(SIOL, "$(P)SIM:DIAMETER:SP")
    field(SDIS, "$(P)DISABLE")
}


### SIMULATION RECORDS ###

record(mbbi, "$(P)SIM:STATUS")
{
    field(SCAN, "Passive")
    field(DTYP, "Soft Channel")
    
    field(ZRVL, "0")
    field(ONVL, "1")
    field(TWVL, "2")
    
    field(ZRST, "Stopped")
    field(ONST, "Infusion")
    field(TWST, "Withdrawal")
}

record(calcout, "$(P)SIM:DIRECTION:REV")
{
    field(SCAN, "Passive")
    field(DTYP, "Soft Channel")
    field(INPA, "$(P)SIM:STATUS")
    field(CALC, "A==1?2:A==2?1:0")
    field(OUT, "$(P)SIM:STATUS PP")    
}

record(calcout, "$(P)SIM:RUN:SP")
{
    field(SCAN, "Passive")
    field(DTYP, "Soft Channel")
    field(INPA, "$(P)SIM:MODE")
    field(CALC, "A==0||A==2||A==4?1:2")
    field(OUT, "$(P)SIM:STATUS")    
}

record(calcout, "$(P)SIM:STOP:SP")
{
    field(SCAN, "Passive")
    field(DTYP, "Soft Channel")
    
    field(CALC, "0")
    field(OUT, "$(P)SIM:STATUS")
}

record(ai, "$(P)SIM:DIAMETER")
{
    field(SCAN, "Passive")
    field(DTYP, "Soft Channel")
}

alias("$(P)SIM:DIAMETER","$(P)SIM:DIAMETER:SP")


record(mbbi, "$(P)SIM:MODE")
{
    field(SCAN, "Passive")
    field(DTYP, "Soft Channel")
    
    field(ZRVL, "0")
    field(ONVL, "1")
    field(TWVL, "2")
    field(THVL, "3")
    field(FRVL, "4")
    
    field(ZRST, "Infusion/Withdrawal")
    field(ONST, "Withdrawal/Infusion")
    field(TWST, "Infusion")
    field(THST, "Withdrawal")
    field(FRST, "Continuous")
    
    field(FLNK, "$(P)SIM:STOP:SP")

}

alias("$(P)SIM:MODE","$(P)SIM:MODE:SP")

record(mbbi, "$(P)SIM:ERROR")
{
    field(SCAN, "Passive")
    field(DTYP, "Soft Channel")
}

record(calc, "$(P)SIM:DIRECTION")
{
    field(SCAN, "Passive")
       
    field(INPA, "$(P)MODE CP")
    field(INPB, "$(P)STATUS CP")
    field(CALC, "B!=0?B-1:A==0||A==2||A==4?0:1")
    
}
